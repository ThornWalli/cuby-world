import{m as de,k as pe,o as he,l as me,P as fe,V as h,S as R,n as E,G as we,I as ye,p as j,e as L,j as b,q as ge,r as be,s as ve,t as xe,d as B,F as W,u as Y,f as Se,v as G,w as Pe,A as Ue,U as oe,x as Ee,M as ne,B as re,O as N,g as $,h as _e,y as X,c as ie,a as Re,b as ae,W as Me,z as Fe,E as $e,H as J,J as Ce,K as Te,N as K,R as Ie}from"./Cu7CViZw.js";import{d as k,k as ke,r as v,o as D,L as ce,E as T,y as w,C as S,B as _,D as z,H as Ae,z as C,x,M as I,I as Le,J as Oe,A as q,F as je,_ as V,K as ze,N as Z,G as Be}from"./DSBH_P4y.js";import{u as Ne}from"./BMJA9sD4.js";function De(i){return de(pe,i)}function Ve(){return De(1)}function Q(i,e){return he(function(t,s){var n=0;t.subscribe(me(s,function(o){return i.call(e,o,n++)&&s.next(o)}))})}class He{id;name;unit;constructor({id:e,name:t}){this.id=e||crypto.randomUUID(),this.name=t}setUnit(e){this.unit=e,fe.TYPE in this.unit.modules&&this.unit.modules.player.setPlayer(this),this.unit.setRootPosition(new h(0,0,0)),console.log("Player unit set:",this.unit.name)}get position(){if(this.unit)return this.unit.root.position;throw new Error("Player unit is not set, cannot get position")}set position(e){if(this.unit)this.unit.setRootPosition(e);else throw new Error("Player unit is not set, cannot update position")}moveTo(e){if(this.unit)this.unit.modules.movement.moveTo(e);else throw new Error("Player unit is not set, cannot move to position")}}class A{constructor(e){this.app=e}static TYPE;subscription=new R;setup(){}destroy(){this.subscription.unsubscribe()}update(){}}class le extends A{static TYPE="unitFocus";state={};focusedUnit$=new E(1);get focusedUnit(){return this.state.focusedUnit}setPlayerAsFocusedUnit(){const e=this.app.modules.player.getPlayer();if(!e?.unit)throw new Error("No player unit to focus on");this.setFocusedUnit(e.unit)}setFocusedUnit(e){const t=this.state.focusedUnit;this.state.focusedUnit=e;const s=this.app.renderer.controls;e?(s.enabled=!1,s.update()):(s.enabled=!0,t&&(s.object.position.copy(this.app.renderer.camera.position),s.target.copy(t.root.position),s.update())),this.focusedUnit$.next(e)}unfocusUnit(){this.setFocusedUnit(void 0)}}function We(i,e=16){const t=i.length,s=i[0].length,n=[];for(let o=0;o<t;o+=e)for(let r=0;r<s;r+=e){const a=[];for(let l=o;l<o+e&&l<t;l++)for(let p=r;p<r+e&&p<s;p++)i[l][p]===1&&a.push(new we(new h(p,0,l)));if(a.length===0)continue;const c=a.reduce((l,p)=>(l[p.type]=l[p.type]||[],l[p.type].push(p),l),{});Object.entries(c).forEach(([l,p])=>{const y=new ye(p[0].plane.geometry,p[0].plane.material,p.length);y.castShadow=!1,y.receiveShadow=!0,y.name=`chunk_${o}_${r}_${l}`;const g=new j;p.forEach((P,M)=>{g.makeTranslation(P.position.x,P.position.y,P.position.z),y.setMatrixAt(M,g)}),n.push(y)})}return n}class Ye{constructor(e){this.app=e,this.mesh=new L,this.mesh.name="room",this.setupSelection()}units=new Map;mesh=new L;groundMesh;selectionMesh;description;get gridSize(){return new b(this.description?.grid[0]?.length||0,this.description?.grid.length||0)}async add(e){await e.setup({unit:e,assetLoader:this.app.texturePreloader,room:this}),this.units.set(e.id,e),console.log("Adding unit:",e.name,"with ID:",e.id),this.mesh.add(e.root)}remove(e){this.units.delete(e.id),this.mesh.remove(e.root)}getById(e){return this.units.get(e)}setupSelection(){const t=new ge,s=.9;t.moveTo(-s/2,-s/2),t.lineTo(s/2,-s/2),t.lineTo(s/2,s/2),t.lineTo(-s/2,s/2),t.lineTo(-s/2,-s/2);const n=new be,o=.9*(4/5);n.moveTo(-o/2,-o/2),n.lineTo(o/2,-o/2),n.lineTo(o/2,o/2),n.lineTo(-o/2,o/2),n.lineTo(-o/2,-o/2),t.holes.push(n);const r=new ve(t);r.translate(0,0,.1),r.rotateX(-Math.PI/2);const a=new xe({color:16777215}),c=new B(r,a);c.position.set(0,0,0),this.mesh.add(c),this.selectionMesh=c}groundChunks=[];setupGround(e){const t=new L;t.name="ground",this.groundChunks=We(e,16),this.groundChunks.forEach(s=>t.add(s)),this.groundMesh=t,this.mesh.add(t)}updateUnitsVisibility(e){const t=new W,s=new j;s.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),t.setFromProjectionMatrix(s),this.units.forEach(n=>{const o=new Y().setFromObject(n.root);n.root.visible=t.intersectsBox(o)})}updateChunksVisibility(e){const t=new W,s=new j;s.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),t.setFromProjectionMatrix(s),this.groundChunks.forEach(n=>{const o=new Y().setFromObject(n);n.visible=t.intersectsBox(o)})}async setupUnits(e){await Promise.all(e.map(t=>{this.add(t)}))}getSize(){return new b(this.description?.grid[0]?.length||0,this.description?.grid.length||0)}update(e){this.updateChunksVisibility(this.app.renderer.camera),this.units.forEach(t=>{t.update(e)})}}class H extends A{static TYPE="room";roomSubscription;state={room:void 0};static async roomFromDescription(e,t){const s=new Ye(e);return s.description=t,s.setupGround(t.grid),await s.setupUnits(t.units||[]),s.mesh.name=t.name,s}getRoom(){return this.state.room}async fromDescription(e){const t=this.app,s=t.renderer,{room:n,player:o,unitFocus:r}=t.modules,a=await H.roomFromDescription(t,e);if(this.roomSubscription){this.roomSubscription.unsubscribe();const c=n.getRoom();c&&s.scene.remove(c.mesh),n.setRoom(void 0)}if(n.setRoom(a),s.scene.add(a.mesh),this.roomSubscription=Ge(t),o&&a.description?.start){const c=new Se({position:a.description.start.position.clone(),rotation:a.description.start.rotation});o.getPlayer().setUnit(c),await a.add(c),t.modules.selection.setSelectedUnit(c),r?.setFocusedUnit(c)}s.animationLoop$.subscribe(c=>{if(a.update(c),r?.focusedUnit){const l=r.focusedUnit.getRootPosition();s.updateCamera(l),s.updateLight(l)}}),console.log("Set room:",e.name,a)}setRoom(e){this.state.room=e}}function Ge(i){const e=new R,t=i.modules.room.getRoom(),s=i.modules.player.getPlayer(),n=i.renderer;if(n.modules.intersection){const o=n.modules.intersection.register(t.mesh.getObjectByName("ground"));e.add(o.hoverIntersect$.pipe(Ve(),Q(r=>r.object?.parent?.name==="ground"),G(),Q(({worldPosition:r})=>!!r)).subscribe(({worldPosition:r})=>{t.selectionMesh.position.copy(r)})),e.add(n.modules.intersection.register(t.mesh).clickIntersect$.pipe(G()).subscribe(r=>{if(r){const{unit:a,object:c,worldPosition:l}=r;i.modules.selection.getSelectedUnit()?.id===a?.id?s.moveTo(a.position):a?i.modules.selection.setSelectedUnit(a):(console.log("Current intersected object:",a,c,l),s.moveTo(Pe(l)))}else console.log("No intersected object")}))}return e}class Xe extends A{static TYPE="player";state={player:void 0};getPlayer(){return this.state.player}setPlayer(e){this.state.player=e}}class Je extends A{static TYPE="selection";state={selectedUnit:void 0};selectUnit$=new E(1);getSelectedUnit(){return this.state.selectedUnit}setSelectedUnit(e){const t=this.app.modules.player.getPlayer(),s=[];!e&&t.unit.id===this.state.selectedUnit?.id||(this.state.selectedUnit?.modules.selection?.unselect(),e?(e.modules.selection?.select(),this.state.selectedUnit=e,s.push(e.mesh)):this.state.selectedUnit=void 0,this.app.renderer.setSelectedObjects(s),this.selectUnit$.next(e))}setSelectedObjects(e){this.app.renderer.setSelectedObjects(e)}}let Ke=class{constructor(e,t=[]){this.renderer=e,t.push(H,Xe,le,Je);const s=t.map(n=>{const o=new n(this);return[n.TYPE,o]});this.modules=Object.fromEntries(s),Object.values(this.modules).forEach(n=>n.setup())}texturePreloader=new Ue;state={};roomSubscription;modules;destroy(){this.roomSubscription?.unsubscribe()}resetCamera(){this.renderer.resetCamera()}};class qe{id;name;description;grid;units;start;constructor({id:e,name:t,description:s,grid:n,units:o,start:r}){this.id=e,this.name=t,this.description=s,this.grid=n,this.units=o||[],this.start=r}}class Ze extends oe{options={size:.5};constructor(e={}){super({...e,name:"Box",selectable:!0})}createMesh(){const e=Ee(64,32,"#ffffff","#000000"),t=new ne({map:e}),s=this.options.size,n=19/20,o=new re(s*1,s*n,s*1),r=new B(o,t);return r.name=N.MESH,r.castShadow=!0,r.position.set(0,s*n/2+.2,0),new h(1,0,0).normalize(),this.materialReady$.next(),r}}class O extends oe{static KEY="box";static NAME="Box";constructor(e={}){super({...e,name:"Block",selectable:!0,options:{size:new h(1,1/3,1),color:14090240,...e.options}})}createMesh(){const e=new ne({color:this.options.color}),t=this.options.size,s=new re(t.x,t.y,t.z),n=new B(s,e);return n.name=N.MESH,n.castShadow=!0,n.position.set(0,t.y/2,0),this.materialReady$.next(),n}}class Qe extends qe{constructor(){super({id:"default",name:"Default Room",description:"This is the default room in Cuby World.",grid:[[0,1,0,1,0],[1,1,1,1,1],[1,0,1,0,1],[1,1,1,1,1],[0,1,0,1,0]],start:{position:new h(2,0,2),rotation:X.RIGHT},units:[new O({position:new h(1,0,0),options:{color:16711680,size:new h(1,1/3,1)}}),new O({position:new h(1,1/3,0),options:{color:65280,size:new h(1,1/3,1)}}),new O({position:new h(1,2/3,0),options:{color:255,size:new h(1,1/3,1)}}),new $({position:new h(0,0,0)}),new _e({position:new h(0,0,2),rotation:X.RIGHT}),new $({position:new h(4,0,0)}),new $({position:new h(4,0,4)}),new $({position:new h(0,0,4)}),new Ze({position:new h(2,0,0)})]})}}const et=k({__name:"CameraControl",props:{app:{}},setup(i){const e=i,t=new R,s=ke(()=>e.app.modules.unitFocus);function n(r){r?s.value.setPlayerAsFocusedUnit():s.value.unfocusUnit()}const o=v(!1);return D(()=>{t.add(s.value.focusedUnit$.subscribe(r=>{r?o.value=!0:o.value=!1}))}),ce(()=>{t.unsubscribe()}),(r,a)=>(w(),T(ie,{class:"cw-panel-camera-control",title:"Camera"},{default:S(()=>[_(Re,{"model-value":o.value,"onUpdate:modelValue":n},{default:S(()=>[...a[1]||(a[1]=[z(" Focused Cuby ",-1)])]),_:1},8,["model-value"]),_(ae,{disabled:o.value,onClick:a[0]||(a[0]=c=>r.app.resetCamera())},{default:S(()=>[...a[2]||(a[2]=[z(" Reset Camera ",-1)])]),_:1},8,["disabled"])]),_:1}))}}),tt={class:"image"},st={key:0},ot={key:1},nt=k({__name:"UnitPreview",props:{unit:{}},setup(i){const e=v(null),t=i,s=v();function n(d){o(d),p(d.mesh),g.render(r,a)}function o(d){const m=d.getRootPosition(),f=d.getRootRotation(),u={Pos:`${m.x.toFixed(2)}x${m.y.toFixed(2)}x${m.z.toFixed(2)}`,Rot:`${f.x.toFixed(2)}x${f.y.toFixed(2)}`,URot:`${t.unit.rotation}`};s.value=Object.entries(u)}let r,a,c;function l(){r=new Fe;const d=1;a=new $e(d*-1,d*1,d*1,d*-1,1,1e3),a.position.set(20,20,20),a.lookAt(0,0,0);const m=new h(10,5,15),f=1;let u;u=new J(16777215,3),u.position.set(m.x,m.y,m.z),u.shadow.mapSize.width=128,u.shadow.mapSize.height=128,u.shadow.camera.left=-f,u.shadow.camera.right=f,u.shadow.camera.top=f,u.shadow.camera.bottom=-f,u.shadow.camera.near=1,u.shadow.camera.far=50,u.shadow.camera.updateProjectionMatrix(),r.add(u),u=new J(16777215,.6),u.position.set(0,3,0),u.castShadow=!0,u.shadow.mapSize.width=128,u.shadow.mapSize.height=128,u.shadow.camera.left=-f,u.shadow.camera.right=f,u.shadow.camera.top=f,u.shadow.camera.bottom=-f,u.shadow.camera.near=1,u.shadow.camera.far=50,u.shadow.camera.updateProjectionMatrix(),r.add(u)}function p(d){if(c){r.remove(c),console.log(c,c.geometry,c.material),c.geometry.dispose();const m=[];Array.isArray(c.material)?m.push(...c.material):m.push(c.material),m.forEach(f=>f.dispose())}if(d){c=d.clone();const m=c.getObjectByName(N.MESH_OUTLINE);m&&(m.visible=!1),r.add(c),c.position.set(0,0,0),c.rotation.set(0,-Math.PI/2,0)}}const y=v(!1);let g;function P(){if(!e.value){console.error("Canvas-Element wurde nicht gefunden.");return}l(),g=new Me({canvas:e.value,alpha:!0});const d=e.value;d&&g.setSize(d.offsetWidth,d.offsetHeight),y.value=!0}D(()=>{P(),M(t.unit)});function M(d){F?.unsubscribe(),F=new R,F.add(d.materialReady$.subscribe(()=>{console.log("Unit ready",d),n(d)})),F.add(d.rotate$.subscribe(m=>{console.log("Unit rotation",m),o(d)}))}let F;return Ae(()=>t.unit,()=>{M(t.unit)}),(d,m)=>(w(),T(ie,{class:"cw-panel-unit-preview",title:d.unit.name},{default:S(()=>[C("div",tt,[C("canvas",{ref_key:"canvasEl",ref:e},null,512)]),s.value?.length?(w(),x("ul",st,[(w(!0),x(Le,null,Oe(s.value,([f,u])=>(w(),x("li",{key:f},[C("span",null,q(f)+":",1),C("span",null,q(u),1)]))),128))])):I("",!0),d.$slots.actions?(w(),x("div",ot,[je(d.$slots,"actions",{},void 0,!0)])):I("",!0)]),_:3},8,["title"]))}}),rt=V(nt,[["__scopeId","data-v-f80548fd"]]);class it extends Ce{static TYPE="intersection";state={};raycaster;mouse;listeners=[];constructor(e){super(e),this.raycaster=new Te,this.mouse=new b}setup(){let e=ee(this.renderer.el);this.subscription.add(K(this.renderer.el,"pointermove").subscribe(t=>{const s=new b(this.renderer.el.offsetWidth,this.renderer.el.offsetHeight),n=(t.clientX-e.x)/s.x*2-1,o=-((t.clientY-e.y)/s.y)*2+1;this.mouse=new b(n,o)})),this.subscription.add(K(this.renderer.el,"pointerdown").subscribe(t=>{const s=new b(this.renderer.el.offsetWidth,this.renderer.el.offsetHeight);e=ee(this.renderer.el);const n=(t.clientX-e.x)/s.x*2-1,o=-((t.clientY-e.y)/s.y)*2+1;this.raycaster.setFromCamera(new b(n,o),this.renderer.camera),this.listeners.forEach(r=>{const a=this.raycaster.intersectObject(r.mesh,!0);a.length>0&&a[0]&&(r.clickIntersect$.next(a[0]),r.clickIntersects$.next(a))})}))}register(e){const t=new E(0),s=new E(0),n=new E(0),o=this.listeners.find(c=>c.mesh===e);if(o)return o;const a={mesh:e,hoverIntersect$:t,clickIntersect$:s,clickIntersects$:n,unregister:()=>{const c=this.listeners.findIndex(l=>l.mesh===e);c!==-1&&this.listeners.splice(c,1)}};return this.listeners.push(a),a}update(){const e=this.mouse;this.mouse.copy(e),this.raycaster.setFromCamera(e,this.renderer.camera),this.listeners.forEach(t=>{const s=this.raycaster.intersectObject(t.mesh,!0);t.hoverIntersect$.next(s)})}}function ee(i){const{left:e,top:t}=i.getBoundingClientRect();return new b(e,t)}const at=new RegExp("([\\p{Ll}\\d])(\\p{Lu})","gu"),ct=new RegExp("(\\p{Lu})([\\p{Lu}][\\p{Ll}])","gu"),lt=new RegExp("(\\d)\\p{Ll}|(\\p{L})\\d","u"),ut=/[^\p{L}\d]+/giu,te="$1\0$2",se="";function ue(i){let e=i.trim();e=e.replace(at,te).replace(ct,te),e=e.replace(ut,"\0");let t=0,s=e.length;for(;e.charAt(t)==="\0";)t++;if(t===s)return[];for(;e.charAt(s-1)==="\0";)s--;return e.slice(t,s).split(/\0/g)}function dt(i){const e=ue(i);for(let t=0;t<e.length;t++){const s=e[t],n=lt.exec(s);if(n){const o=n.index+(n[1]??n[2]).length;e.splice(t,1,s.slice(0,o),s.slice(o))}}return e}function pt(i,e){const[t,s,n]=ft(i,e);return t+s.map(mt(e?.locale)).join(e?.delimiter??" ")+n}function ht(i,e){return pt(i,{delimiter:"-",...e})}function mt(i){return i===!1?e=>e.toLowerCase():e=>e.toLocaleLowerCase(i)}function ft(i,e={}){const t=e.split??(e.separateNumbers?dt:ue),s=e.prefixCharacters??se,n=e.suffixCharacters??se;let o=0,r=i.length;for(;o<i.length;){const a=i.charAt(o);if(!s.includes(a))break;o++}for(;r>o;){const a=r-1,c=i.charAt(a);if(!n.includes(c))break;r=a}return[i.slice(0,o),t(i.slice(o,r)),i.slice(r)]}const U=v([]);function wt(){const i=e=>{e=e.filter(t=>!U.value.find(s=>s.fontFamily===t.fontFamily)),U.value=[...U.value,...e]};return Ne(()=>({link:U.value.filter(e=>e.preload).map(e=>({key:`preload-${ht(e.fontFamily)}`,rel:"preload",as:"font",href:e.src[0],type:`font/${e.src[1]}`,crossorigin:"anonymous"})),style:[{key:"fonts",innerHTML:yt(U.value)}]})),{registerFont:i}}function yt(i){return i.map(e=>`
@font-face {
  font-family: "${e.fontFamily}";
  font-variant: ${e.fontVariant};
  font-feature-settings: ${e.fontFeatureSettings};
  font-stretch: ${e.fontStretch};
  font-weight: ${e.fontWeight};
  font-style: ${e.fontStyle};
  font-display: ${e.fontDisplay};
  src: url(${e.src[0]}) format("${e.src[1]}");
}
`).join(`
`)}const gt=""+new URL("open-sans-v43-latin-regular.D-erVzNr.woff2",import.meta.url).href,bt=""+new URL("open-sans-v43-latin-700.BH5mO96r.woff2",import.meta.url).href;function vt(){const{registerFont:i}=wt();i([{fontFamily:"Open Sans",fontVariant:"normal",fontFeatureSettings:"normal",fontStretch:"normal",fontWeight:400,fontStyle:"normal",fontDisplay:"swap",src:[gt,"woff2"]},{fontFamily:"Open Sans",fontVariant:"normal",fontFeatureSettings:"normal",fontStretch:"normal",fontWeight:700,fontStyle:"normal",fontDisplay:"swap",src:[bt,"woff2"]}])}const xt={ref:"rootEl",class:"cw-app"},St=k({__name:"App",props:{rendererOptions:{}},setup(i){const e=v(null),t=new R,s=v();let n;vt();const o=v(),r=v(null);D(async()=>{ze(()=>{a()})});function a(){const{$el:l,renderer:p}=e.value;if(!p)throw new Error("Renderer not ready");o.value=Z(new Ke(p,[le])),window.cubyWorld=o.value,o.value.modules.player.setPlayer(new He({name:"Player 1"})),o.value.modules.room.fromDescription(new Qe),t.add(o.value.modules.selection.selectUnit$.subscribe(g=>{r.value=g?Z(g):null}));const y=()=>{s.value=new b(l.offsetWidth,l.offsetHeight),p.resize(s.value)};n=new ResizeObserver(y),n.observe(l)}ce(()=>{n.disconnect(),t.unsubscribe(),o.value?.destroy()});function c(){r.value&&r.value.rotateRight()}return(l,p)=>(w(),x("div",xt,[_(Ie,{ref_key:"rendererEl",ref:e,debug:"",options:l.rendererOptions,modules:[Be(it)]},null,8,["options","modules"]),r.value?(w(),T(rt,{key:0,unit:r.value},{actions:S(()=>[_(ae,{onClick:c},{default:S(()=>[...p[0]||(p[0]=[z("Rotate",-1)])]),_:1})]),_:1},8,["unit"])):I("",!0),o.value?(w(),T(et,{key:1,app:o.value},null,8,["app"])):I("",!0)],512))}}),Pt=V(St,[["__scopeId","data-v-7c6d7172"]]),Ut=k({__name:"index",setup(i){return(e,t)=>(w(),x("div",null,[_(Pt)]))}}),Ft=V(Ut,[["__scopeId","data-v-46b16963"]]);export{Ft as default};
